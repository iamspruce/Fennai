name: Deploy to Firebase & Cloud Run

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      deploy_hosting:
        description: "Deploy Frontend (Firebase Hosting)"
        required: false
        type: boolean
        default: false
      deploy_inference:
        description: "Deploy Cloud Run Inference"
        required: false
        type: boolean
        default: false
      deploy_proxy:
        description: "Deploy Proxy Functions"
        required: false
        type: boolean
        default: false
      deploy_all:
        description: "Deploy Everything"
        required: false
        type: boolean
        default: false

jobs:
  # ==================== VALIDATION ====================
  validate-inputs:
    name: Validate Deployment Inputs
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Check if any deployment selected
        run: |
          if [ "${{ inputs.deploy_hosting }}" != "true" ] && \
             [ "${{ inputs.deploy_inference }}" != "true" ] && \
             [ "${{ inputs.deploy_proxy }}" != "true" ] && \
             [ "${{ inputs.deploy_all }}" != "true" ]; then
            echo "‚ùå Error: No deployment option selected!"
            echo "Please select at least one deployment option:"
            echo "  - Deploy Hosting"
            echo "  - Deploy Inference"
            echo "  - Deploy Proxy"
            echo "  - Deploy All"
            exit 1
          fi
          echo "‚úÖ Deployment options validated"

  # ==================== FRONTEND HOSTING ====================
  deploy-hosting:
    name: Deploy Frontend (Firebase Hosting)
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && (inputs.deploy_hosting == true || inputs.deploy_all == true)) ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[deploy:hosting]') || contains(github.event.head_commit.message, '[deploy:all]'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo "‚úÖ .env created."

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: fennai
          channelId: live
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks

  # ==================== INFRASTRUCTURE SETUP ====================
  setup-infrastructure:
    name: Setup GCP Infrastructure
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && (inputs.deploy_inference == true || inputs.deploy_proxy == true || inputs.deploy_all == true)) ||
      (github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || contains(github.event.head_commit.message, '[deploy:inference]') || contains(github.event.head_commit.message, '[deploy:proxy]') || contains(github.event.head_commit.message, '[deploy:all]')))
    permissions:
      contents: read
      id-token: write
    outputs:
      cloud_run_url: ${{ steps.get_urls.outputs.cloud_run_url }}
      service_account: ${{ steps.get_urls.outputs.service_account }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: fennai

      - name: Enable Required APIs
        run: |
          echo "üîß Enabling required GCP APIs..."
          gcloud services enable speech.googleapis.com
          gcloud services enable translate.googleapis.com
          gcloud services enable cloudtasks.googleapis.com
          gcloud services enable cloudbuild.googleapis.com
          gcloud services enable run.googleapis.com
          gcloud services enable firestore.googleapis.com
          gcloud services enable storage.googleapis.com
          gcloud services enable cloudfunctions.googleapis.com
          gcloud services enable cloudscheduler.googleapis.com
          gcloud services enable pubsub.googleapis.com
          gcloud services enable secretmanager.googleapis.com
          gcloud services enable iamcredentials.googleapis.com
          echo "‚úÖ APIs enabled"

      - name: Create Voice Output Bucket
        run: |
          BUCKET_NAME="fennai-voice-output"
          REGION="us-central1"
          if gsutil ls -b gs://$BUCKET_NAME 2>/dev/null; then
            echo "‚úÖ Bucket gs://$BUCKET_NAME already exists"
          else
            echo "Creating bucket gs://$BUCKET_NAME"
            gsutil mb -p fennai -c STANDARD -l $REGION gs://$BUCKET_NAME
            echo "‚úÖ Bucket created successfully"
          fi
          echo '{
            "lifecycle": {
              "rule": [{
                "action": {"type": "Delete"},
                "condition": {"age": 1}
              }]
            }
          }' > lifecycle.json
          gsutil lifecycle set lifecycle.json gs://$BUCKET_NAME
          echo '[{
            "origin": ["*"],
            "method": ["GET", "HEAD"],
            "responseHeader": ["Content-Type"],
            "maxAgeSeconds": 3600
          }]' > cors.json
          gsutil cors set cors.json gs://$BUCKET_NAME
          echo "‚úÖ Lifecycle policy set (24-hour auto-delete)"
          echo "‚úÖ CORS configured"
          rm lifecycle.json cors.json

      - name: Create Dubbing Temp Bucket
        run: |
          BUCKET_NAME="fennai-dubbing-temp"
          REGION="us-central1"
          if gsutil ls -b gs://$BUCKET_NAME 2>/dev/null; then
            echo "‚úÖ Bucket gs://$BUCKET_NAME already exists"
          else
            echo "Creating bucket gs://$BUCKET_NAME"
            gsutil mb -p fennai -c STANDARD -l $REGION gs://$BUCKET_NAME
            echo "‚úÖ Bucket created successfully"
          fi
          echo '{
            "lifecycle": {
              "rule": [{
                "action": {"type": "Delete"},
                "condition": {"age": 7}
              }]
            }
          }' > lifecycle.json
          gsutil lifecycle set lifecycle.json gs://$BUCKET_NAME
          echo '[{
            "origin": ["*"],
            "method": ["GET", "HEAD"],
            "responseHeader": ["Content-Type"],
            "maxAgeSeconds": 3600
          }]' > cors.json
          gsutil cors set cors.json gs://$BUCKET_NAME
          echo "‚úÖ Lifecycle policy set (7-day auto-delete)"
          echo "‚úÖ CORS configured"
          rm lifecycle.json cors.json

      - name: Create Cloud Tasks Queue
        run: |
          QUEUE_NAME="voice-generation-queue"
          LOCATION="us-central1"
          if gcloud tasks queues describe $QUEUE_NAME --location=$LOCATION 2>/dev/null; then
            echo "‚úÖ Queue $QUEUE_NAME already exists"
          else
            echo "Creating Cloud Tasks queue..."
            gcloud tasks queues create $QUEUE_NAME \
              --location=$LOCATION \
              --max-dispatches-per-second=10 \
              --max-concurrent-dispatches=5 \
              --max-attempts=3 \
              --min-backoff=10s \
              --max-backoff=300s \
              --max-doublings=3 \
              --max-retry-duration=1800s
            echo "‚úÖ Queue created successfully"
          fi

      - name: Create Pub/Sub Topic for Cleanup
        run: |
          TOPIC_NAME="credit-cleanup"
          if gcloud pubsub topics describe $TOPIC_NAME 2>/dev/null; then
            echo "‚úÖ Topic $TOPIC_NAME already exists"
          else
            echo "Creating Pub/Sub topic for cleanup..."
            gcloud pubsub topics create $TOPIC_NAME
            echo "‚úÖ Topic created successfully"
          fi

      - name: Create Cloud Scheduler Job for Credit Cleanup
        run: |
          JOB_NAME="credit-cleanup-hourly"
          LOCATION="us-central1"
          TOPIC="credit-cleanup"

          if gcloud scheduler jobs describe $JOB_NAME --location=$LOCATION 2>/dev/null; then
            echo "Updating existing scheduler job..."
            gcloud scheduler jobs update pubsub $JOB_NAME \
              --location=$LOCATION \
              --schedule="0 * * * *" \
              --topic=$TOPIC \
              --message-body='{"action":"cleanup"}' \
              --time-zone="America/New_York"
          else
            echo "Creating new scheduler job..."
            gcloud scheduler jobs create pubsub $JOB_NAME \
              --location=$LOCATION \
              --schedule="0 * * * *" \
              --topic=$TOPIC \
              --message-body='{"action":"cleanup"}' \
              --time-zone="America/New_York"
          fi

          echo "‚úÖ Scheduler job configured (runs hourly)"

      - name: Get Existing URLs and Service Account
        id: get_urls
        run: |
          # Try to get existing Cloud Run URL
          CLOUD_RUN_URL=$(gcloud run services describe fennai-inference \
            --region=us-central1 \
            --format='value(status.url)' 2>/dev/null || echo "")

          # Get service account
          SA=$(gcloud run services describe fennai-inference \
            --region=us-central1 \
            --format='value(spec.template.spec.serviceAccountName)' 2>/dev/null || echo "")

          if [ -z "$SA" ]; then
            PROJECT_NUMBER=$(gcloud projects describe fennai --format='value(projectNumber)')
            SA="${PROJECT_NUMBER}-compute@developer.gserviceaccount.com"
          fi

          echo "cloud_run_url=$CLOUD_RUN_URL" >> $GITHUB_OUTPUT
          echo "service_account=$SA" >> $GITHUB_OUTPUT
          echo "‚úÖ Current Cloud Run URL: $CLOUD_RUN_URL"
          echo "‚úÖ Service Account: $SA"

  # ==================== CLOUD RUN INFERENCE ====================
  deploy-inference:
    name: Deploy Cloud Run GPU Inference
    runs-on: ubuntu-latest
    needs: setup-infrastructure
    if: |
      (github.event_name == 'workflow_dispatch' && (inputs.deploy_inference == true || inputs.deploy_all == true)) ||
      (github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || contains(github.event.head_commit.message, '[deploy:inference]') || contains(github.event.head_commit.message, '[deploy:all]')))
    permissions:
      contents: read
      id-token: write
    outputs:
      cloud_run_url: ${{ steps.deploy_run.outputs.CLOUD_RUN_URL }}
      service_account: ${{ steps.vars.outputs.SERVICE_ACCOUNT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: fennai

      - name: Build GPU Inference Image
        run: |
          echo "Building Docker image with model + FFmpeg + Resemblyzer..."
          gcloud builds submit \
            --config functions/inference/cloudbuild.yaml \
            --timeout=2400s \
            --substitutions _HF_TOKEN=${{ secrets.HF_TOKEN }} \
            functions/inference

      - name: Prepare Variables
        id: vars
        run: |
          SA="${{ needs.setup-infrastructure.outputs.service_account }}"
          echo "SERVICE_ACCOUNT=$SA" >> $GITHUB_OUTPUT
          echo "‚úÖ Using Service Account: $SA"

      - name: Deploy Inference to Cloud Run
        id: deploy_run
        run: |
          SA="${{ steps.vars.outputs.SERVICE_ACCOUNT }}"

          URL=$(gcloud run deploy fennai-inference \
              --image gcr.io/fennai/fennai-inference:latest \
              --platform managed \
              --region us-central1 \
              --execution-environment gen2 \
              --allow-unauthenticated \
              --service-account "$SA" \
              --cpu 8 \
              --memory 32Gi \
              --gpu 1 \
              --gpu-type nvidia-l4 \
              --no-gpu-zonal-redundancy \
              --max-instances 3 \
              --min-instances 0 \
              --timeout 900s \
              --port 8080 \
              --cpu-boost \
              --concurrency=1 \
              --set-env-vars "INTERNAL_TOKEN=${{ secrets.INTERNAL_TOKEN }}" \
              --set-env-vars "MODEL_NAME=microsoft/VibeVoice-1.5B" \
              --set-env-vars "GCS_BUCKET=fennai-voice-output" \
              --set-env-vars "GCS_DUBBING_BUCKET=fennai-dubbing-temp" \
              --set-env-vars "GCP_PROJECT=fennai" \
              --set-env-vars "QUEUE_LOCATION=us-central1" \
              --set-env-vars "QUEUE_NAME=voice-generation-queue" \
              --set-env-vars "SERVICE_ACCOUNT_EMAIL=$SA" \
              --quiet \
              --format='value(status.url)')

          echo "CLOUD_RUN_URL=$URL" >> $GITHUB_OUTPUT
          echo "CLOUD_RUN_URL=$URL" >> $GITHUB_ENV
          echo "‚úÖ Cloud Run deployed to: $URL"

          echo "Setting CLOUD_RUN_URL environment variable..."
          gcloud run services update fennai-inference \
              --region us-central1 \
              --update-env-vars "CLOUD_RUN_URL=$URL" \
              --quiet

          echo "‚úÖ CLOUD_RUN_URL configured"

      - name: Grant IAM Token Creator Role for Signed URLs
        run: |
          SA="${{ steps.vars.outputs.SERVICE_ACCOUNT }}"

          echo "Granting iam.serviceAccountTokenCreator role for signed URL generation..."
          gcloud projects add-iam-policy-binding fennai \
            --member="serviceAccount:${SA}" \
            --role="roles/iam.serviceAccountTokenCreator" \
            --condition=None

          echo "‚úÖ IAM signing permissions granted to $SA"

      - name: Verify Cloud Run Deployment
        run: |
          echo "Waiting for Cloud Run to be ready..."
          HEALTH_URL="${{ steps.deploy_run.outputs.CLOUD_RUN_URL }}/health"

          for i in {1..5}; do
            echo "Health check attempt $i/5..."
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$HEALTH_URL" || echo "000")
            
            if [ "$RESPONSE" = "200" ]; then
              echo "‚úÖ Cloud Run is healthy"
              exit 0
            else
              echo "‚ö†Ô∏è  Response: $RESPONSE (waiting 10s...)"
              sleep 10
            fi
          done

          echo "‚ùå Health check failed after 5 attempts"
          exit 1

  # ==================== PROXY FUNCTIONS ====================
  deploy-proxy:
    name: Deploy Proxy Functions
    runs-on: ubuntu-latest
    needs: [setup-infrastructure, deploy-inference]
    if: |
      always() &&
      needs.setup-infrastructure.result == 'success' &&
      (needs.deploy-inference.result == 'success' || needs.deploy-inference.result == 'skipped') &&
      (
        (github.event_name == 'workflow_dispatch' && (inputs.deploy_proxy == true || inputs.deploy_all == true)) ||
        (github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || contains(github.event.head_commit.message, '[deploy:proxy]') || contains(github.event.head_commit.message, '[deploy:all]')))
      )
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: fennai

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Get Cloud Run URL and Service Account
        id: get_config
        run: |
          # Try to get URL from newly deployed inference
          if [ -n "${{ needs.deploy-inference.outputs.cloud_run_url }}" ]; then
            CLOUD_RUN_URL="${{ needs.deploy-inference.outputs.cloud_run_url }}"
            echo "‚úÖ Using newly deployed Cloud Run URL"
          # Otherwise get from setup-infrastructure job
          elif [ -n "${{ needs.setup-infrastructure.outputs.cloud_run_url }}" ]; then
            CLOUD_RUN_URL="${{ needs.setup-infrastructure.outputs.cloud_run_url }}"
            echo "‚úÖ Using existing Cloud Run URL from setup job"
          # Last resort: query GCP directly
          else
            echo "‚ö†Ô∏è  No URL in job outputs, querying GCP..."
            CLOUD_RUN_URL=$(gcloud run services describe fennai-inference \
              --region=us-central1 \
              --format='value(status.url)' 2>/dev/null || echo "")
            if [ -n "$CLOUD_RUN_URL" ]; then
              echo "‚úÖ Retrieved Cloud Run URL from GCP"
            fi
          fi

          # Exit if still no URL found
          if [ -z "$CLOUD_RUN_URL" ]; then
            echo "‚ùå No Cloud Run service found. You must deploy inference at least once before deploying proxy."
            echo "Run with [deploy:all] or [deploy:inference] first."
            exit 1
          fi

          # Get service account (similar logic)
          if [ -n "${{ needs.deploy-inference.outputs.service_account }}" ]; then
            SA="${{ needs.deploy-inference.outputs.service_account }}"
          elif [ -n "${{ needs.setup-infrastructure.outputs.service_account }}" ]; then
            SA="${{ needs.setup-infrastructure.outputs.service_account }}"
          else
            SA=$(gcloud run services describe fennai-inference \
              --region=us-central1 \
              --format='value(spec.template.spec.serviceAccountName)' 2>/dev/null || echo "")
            
            if [ -z "$SA" ]; then
              PROJECT_NUMBER=$(gcloud projects describe fennai --format='value(projectNumber)')
              SA="${PROJECT_NUMBER}-compute@developer.gserviceaccount.com"
            fi
          fi

          echo "CLOUD_RUN_URL=$CLOUD_RUN_URL" >> $GITHUB_OUTPUT
          echo "SERVICE_ACCOUNT=$SA" >> $GITHUB_OUTPUT
          echo "‚úÖ Cloud Run URL: $CLOUD_RUN_URL"
          echo "‚úÖ Service Account: $SA"

      - name: Create .env for proxy function
        run: |
          cd functions/proxy
          echo "CLOUD_RUN_URL=${{ steps.get_config.outputs.CLOUD_RUN_URL }}" > .env
          echo "INTERNAL_TOKEN=${{ secrets.INTERNAL_TOKEN }}" >> .env
          echo "QUEUE_LOCATION=us-central1" >> .env
          echo "QUEUE_NAME=voice-generation-queue" >> .env
          echo "SERVICE_ACCOUNT_EMAIL=${{ steps.get_config.outputs.SERVICE_ACCOUNT }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          echo "GCS_DUBBING_BUCKET=fennai-dubbing-temp" >> .env
          echo "‚úÖ Proxy .env created"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Setup Python virtual environment for proxy function
        run: |
          cd functions/proxy
          python3.11 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Deploy Proxy Functions
        run: |
          echo "Deploying Firebase Functions..."
          firebase deploy \
              --only functions:proxy \
              --project fennai \
              --non-interactive
          echo "‚úÖ Functions deployed"

  # ==================== DEPLOYMENT SUMMARY ====================
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-hosting, deploy-inference, deploy-proxy]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "================================"
          echo "üöÄ DEPLOYMENT SUMMARY"
          echo "================================"
          echo ""
          echo "üì¶ Jobs Status:"
          echo "  Hosting: ${{ needs.deploy-hosting.result || 'skipped' }}"
          echo "  Inference: ${{ needs.deploy-inference.result || 'skipped' }}"
          echo "  Proxy: ${{ needs.deploy-proxy.result || 'skipped' }}"
          echo ""
          if [ -n "${{ needs.deploy-inference.outputs.cloud_run_url }}" ]; then
            echo "üîå Cloud Run URL: ${{ needs.deploy-inference.outputs.cloud_run_url }}"
            echo "üîß Service Account: ${{ needs.deploy-inference.outputs.service_account }}"
          fi
          echo ""

          # Check if any deployment failed
          if [ "${{ needs.deploy-hosting.result }}" = "failure" ] || \
             [ "${{ needs.deploy-inference.result }}" = "failure" ] || \
             [ "${{ needs.deploy-proxy.result }}" = "failure" ]; then
            echo "‚ùå Some deployments failed. Check logs above."
            exit 1
          fi

          echo "‚úÖ All requested deployments completed successfully"
          echo "================================"
