name: Deploy to Firebase & Cloud Run
on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

jobs:
  deploy-hosting:
    name: Deploy Frontend (Firebase Hosting)
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'deploy:hosting') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo "‚úÖ .env created."
      
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: fennai
          channelId: live
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks

  deploy-backend:
    name: Deploy Functions + Cloud Run GPU Inference
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: fennai
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # ==================== ENABLE APIS FIRST ====================
      
      - name: Enable Required APIs
        run: |
          echo "üîß Enabling required GCP APIs..."
          gcloud services enable speech.googleapis.com
          gcloud services enable translate.googleapis.com
          gcloud services enable cloudtasks.googleapis.com
          gcloud services enable cloudbuild.googleapis.com
          gcloud services enable run.googleapis.com
          gcloud services enable firestore.googleapis.com
          gcloud services enable storage.googleapis.com
          gcloud services enable cloudfunctions.googleapis.com
          gcloud services enable cloudscheduler.googleapis.com
          gcloud services enable pubsub.googleapis.com
          gcloud services enable secretmanager.googleapis.com
          echo "‚úÖ APIs enabled"

      # ==================== STORAGE BUCKETS ====================
      
      - name: Create Voice Output Bucket
        run: |
          BUCKET_NAME="fennai-voice-output"
          REGION="us-central1"
          if gsutil ls -b gs://$BUCKET_NAME 2>/dev/null; then
            echo "‚úÖ Bucket gs://$BUCKET_NAME already exists"
          else
            echo "Creating bucket gs://$BUCKET_NAME"
            gsutil mb -p fennai -c STANDARD -l $REGION gs://$BUCKET_NAME
            echo "‚úÖ Bucket created successfully"
          fi
          # 24-hour lifecycle policy
          echo '{
            "lifecycle": {
              "rule": [{
                "action": {"type": "Delete"},
                "condition": {"age": 1}
              }]
            }
          }' > lifecycle.json
          gsutil lifecycle set lifecycle.json gs://$BUCKET_NAME
          
          # Enable CORS for signed URLs
          echo '[{
            "origin": ["*"],
            "method": ["GET", "HEAD"],
            "responseHeader": ["Content-Type"],
            "maxAgeSeconds": 3600
          }]' > cors.json
          gsutil cors set cors.json gs://$BUCKET_NAME
          
          echo "‚úÖ Lifecycle policy set (24-hour auto-delete)"
          echo "‚úÖ CORS configured"
          rm lifecycle.json cors.json

      - name: Create Dubbing Temp Bucket
        run: |
          BUCKET_NAME="fennai-dubbing-temp"
          REGION="us-central1"
          if gsutil ls -b gs://$BUCKET_NAME 2>/dev/null; then
            echo "‚úÖ Bucket gs://$BUCKET_NAME already exists"
          else
            echo "Creating bucket gs://$BUCKET_NAME"
            gsutil mb -p fennai -c STANDARD -l $REGION gs://$BUCKET_NAME
            echo "‚úÖ Bucket created successfully"
          fi
          # 7-day lifecycle policy for dubbing files
          echo '{
            "lifecycle": {
              "rule": [{
                "action": {"type": "Delete"},
                "condition": {"age": 7}
              }]
            }
          }' > lifecycle.json
          gsutil lifecycle set lifecycle.json gs://$BUCKET_NAME
          
          # Enable CORS
          echo '[{
            "origin": ["*"],
            "method": ["GET", "HEAD"],
            "responseHeader": ["Content-Type"],
            "maxAgeSeconds": 3600
          }]' > cors.json
          gsutil cors set cors.json gs://$BUCKET_NAME
          
          echo "‚úÖ Lifecycle policy set (7-day auto-delete)"
          echo "‚úÖ CORS configured"
          rm lifecycle.json cors.json

      # ==================== CLOUD TASKS QUEUE ====================
      
      - name: Create Cloud Tasks Queue
        run: |
          QUEUE_NAME="voice-generation-queue"
          LOCATION="us-central1"
          if gcloud tasks queues describe $QUEUE_NAME --location=$LOCATION 2>/dev/null; then
            echo "‚úÖ Queue $QUEUE_NAME already exists"
          else
            echo "Creating Cloud Tasks queue..."
            gcloud tasks queues create $QUEUE_NAME \
              --location=$LOCATION \
              --max-dispatches-per-second=10 \
              --max-concurrent-dispatches=5 \
              --max-attempts=3 \
              --min-backoff=10s \
              --max-backoff=300s \
              --max-doublings=3 \
              --max-retry-duration=1800s
            echo "‚úÖ Queue created successfully"
          fi

      # ==================== PUB/SUB FOR CLEANUP ====================
      
      - name: Create Pub/Sub Topic for Cleanup
        run: |
          TOPIC_NAME="credit-cleanup"
          if gcloud pubsub topics describe $TOPIC_NAME 2>/dev/null; then
            echo "‚úÖ Topic $TOPIC_NAME already exists"
          else
            echo "Creating Pub/Sub topic for cleanup..."
            gcloud pubsub topics create $TOPIC_NAME
            echo "‚úÖ Topic created successfully"
          fi

      # ==================== FIRESTORE INDEXES ====================
      
      - name: Deploy Firestore Indexes
        run: |
          echo "Deploying Firestore indexes..."
          firebase deploy --only firestore:indexes --project fennai --non-interactive || echo "‚ö†Ô∏è  Indexes deployment skipped (may not be configured)"

      # ==================== CLOUD RUN INFERENCE ====================
      
      - name: Build GPU Inference Image
        run: |
          echo "Building Docker image with model + FFmpeg + Resemblyzer..."
          echo "‚ö†Ô∏è  This will take ~90-120 seconds"
          gcloud builds submit \
            --config functions/inference/cloudbuild.yaml \
            --timeout=2400s \
            --substitutions _HF_TOKEN=${{ secrets.HF_TOKEN }} \
            functions/inference

      - name: Deploy Inference to Cloud Run
        id: deploy_run
        run: |
          URL=$(gcloud run deploy fennai-inference \
              --image gcr.io/fennai/fennai-inference:latest \
              --platform managed \
              --region us-central1 \
              --execution-environment gen2 \
              --allow-unauthenticated \
              --cpu 8 \
              --memory 32Gi \
              --gpu 1 \
              --gpu-type nvidia-l4 \
              --no-gpu-zonal-redundancy \
              --max-instances 3 \
              --min-instances 0 \
              --timeout 900s \
              --port 8080 \
              --cpu-boost \
              --concurrency=1 \
              --quiet \
              --format='value(status.url)')
          echo "CLOUD_RUN_URL=$URL" >> $GITHUB_OUTPUT
          echo "CLOUD_RUN_URL=$URL" >> $GITHUB_ENV
          echo "‚úÖ Cloud Run deployed to: $URL"

      - name: Get Cloud Run Service Account
        id: get_sa
        run: |
          SA=$(gcloud run services describe fennai-inference \
              --region=us-central1 \
              --format='value(spec.template.spec.serviceAccountName)')
          if [ -z "$SA" ]; then
            # Use default compute service account
            PROJECT_NUMBER=$(gcloud projects describe fennai --format='value(projectNumber)')
            SA="${PROJECT_NUMBER}-compute@developer.gserviceaccount.com"
          fi
          echo "SERVICE_ACCOUNT=$SA" >> $GITHUB_OUTPUT
          echo "‚úÖ Service Account: $SA"

      - name: Update Cloud Run with Service Account
        run: |
          SA="${{ steps.get_sa.outputs.SERVICE_ACCOUNT }}"
          gcloud run services update fennai-inference \
            --region=us-central1 \
            --set-env-vars "INTERNAL_TOKEN=${{ secrets.INTERNAL_TOKEN }},MODEL_NAME=microsoft/VibeVoice-1.5B,GCS_BUCKET=fennai-voice-output,GCS_DUBBING_BUCKET=fennai-dubbing-temp,GCP_PROJECT=fennai,QUEUE_LOCATION=us-central1,QUEUE_NAME=voice-generation-queue,CLOUD_RUN_URL=${{ steps.deploy_run.outputs.CLOUD_RUN_URL }},SERVICE_ACCOUNT_EMAIL=${SA}"
          echo "‚úÖ Environment variables updated"

      - name: Grant Storage Permissions to Cloud Run
        run: |
          SA="${{ steps.get_sa.outputs.SERVICE_ACCOUNT }}"
          gsutil iam ch serviceAccount:${SA}:objectAdmin gs://fennai-voice-output
          gsutil iam ch serviceAccount:${SA}:objectAdmin gs://fennai-dubbing-temp
          echo "‚úÖ Storage permissions granted"

      - name: Grant Cloud Tasks Permissions to Cloud Run
        run: |
          SA="${{ steps.get_sa.outputs.SERVICE_ACCOUNT }}"
          gcloud projects add-iam-policy-binding fennai \
            --member="serviceAccount:${SA}" \
            --role="roles/cloudtasks.enqueuer" \
            --condition=None
          echo "‚úÖ Cloud Tasks enqueuer permissions granted"

      - name: Grant Firestore Permissions to Cloud Run
        run: |
          SA="${{ steps.get_sa.outputs.SERVICE_ACCOUNT }}"
          gcloud projects add-iam-policy-binding fennai \
            --member="serviceAccount:${SA}" \
            --role="roles/datastore.user" \
            --condition=None
          echo "‚úÖ Firestore permissions granted"

      - name: Verify Cloud Run Deployment
        run: |
          echo "Waiting for Cloud Run to be ready..."
          HEALTH_URL="${{ steps.deploy_run.outputs.CLOUD_RUN_URL }}/health"
          
          # Retry health check up to 5 times
          for i in {1..5}; do
            echo "Health check attempt $i/5..."
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$HEALTH_URL" || echo "000")
            
            if [ "$RESPONSE" = "200" ]; then
              echo "‚úÖ Cloud Run is healthy"
              curl -s "$HEALTH_URL" | jq . || true
              exit 0
            else
              echo "‚ö†Ô∏è  Response: $RESPONSE (waiting 10s...)"
              sleep 10
            fi
          done
          
          echo "‚ùå Health check failed after 5 attempts"
          exit 1

      # ==================== PROXY FUNCTIONS ====================

      - name: Create .env for proxy function
        run: |
          cd functions/proxy
          echo "CLOUD_RUN_URL=${{ steps.deploy_run.outputs.CLOUD_RUN_URL }}" > .env
          echo "INTERNAL_TOKEN=${{ secrets.INTERNAL_TOKEN }}" >> .env
          echo "GCP_PROJECT=fennai" >> .env
          echo "QUEUE_LOCATION=us-central1" >> .env
          echo "QUEUE_NAME=voice-generation-queue" >> .env
          echo "SERVICE_ACCOUNT_EMAIL=${{ steps.get_sa.outputs.SERVICE_ACCOUNT }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          echo "GCS_DUBBING_BUCKET=fennai-dubbing-temp" >> .env
          echo "‚úÖ Proxy .env created"

      - name: Grant Permissions to Firebase Functions Service Account
        run: |
          # Get the default App Engine service account (used by Firebase Functions)
          PROJECT_NUMBER=$(gcloud projects describe fennai --format='value(projectNumber)')
          FUNCTIONS_SA="${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com"
          
          # Grant necessary permissions
          echo "Granting permissions to Firebase Functions SA: $FUNCTIONS_SA"
          
          # Storage permissions
          gsutil iam ch serviceAccount:${FUNCTIONS_SA}:objectAdmin gs://fennai-voice-output
          gsutil iam ch serviceAccount:${FUNCTIONS_SA}:objectAdmin gs://fennai-dubbing-temp
          
          # Cloud Tasks permissions
          gcloud projects add-iam-policy-binding fennai \
            --member="serviceAccount:${FUNCTIONS_SA}" \
            --role="roles/cloudtasks.enqueuer" \
            --condition=None
          
          # Pub/Sub permissions for cleanup function
          gcloud projects add-iam-policy-binding fennai \
            --member="serviceAccount:${FUNCTIONS_SA}" \
            --role="roles/pubsub.subscriber" \
            --condition=None
          
          echo "‚úÖ Firebase Functions permissions granted"

      - name: Deploy Proxy Functions
        run: |
          echo "Deploying Firebase Functions..."
          firebase deploy \
              --only functions \
              --project fennai \
              --non-interactive
          echo "‚úÖ Functions deployed"

      # ==================== CLOUD SCHEDULER FOR CLEANUP ====================
      
      - name: Create Cloud Scheduler Job for Credit Cleanup
        run: |
          JOB_NAME="credit-cleanup-hourly"
          LOCATION="us-central1"
          TOPIC="credit-cleanup"
          
          # Check if job exists
          if gcloud scheduler jobs describe $JOB_NAME --location=$LOCATION 2>/dev/null; then
            echo "Updating existing scheduler job..."
            gcloud scheduler jobs update pubsub $JOB_NAME \
              --location=$LOCATION \
              --schedule="0 * * * *" \
              --topic=$TOPIC \
              --message-body='{"action":"cleanup"}' \
              --time-zone="America/New_York"
          else
            echo "Creating new scheduler job..."
            gcloud scheduler jobs create pubsub $JOB_NAME \
              --location=$LOCATION \
              --schedule="0 * * * *" \
              --topic=$TOPIC \
              --message-body='{"action":"cleanup"}' \
              --time-zone="America/New_York"
          fi
          
          echo "‚úÖ Scheduler job configured (runs hourly)"

      # ==================== FIRESTORE TTL POLICY ====================
      
      - name: Configure Firestore TTL for Script Generations
        run: |
          echo "‚ö†Ô∏è  Configure Firestore TTL manually:"
          echo "1. Go to Firestore console"
          echo "2. Select 'scriptGenerations' collection"
          echo "3. Enable TTL on 'createdAt' field (delete after 7 days)"
          echo ""
          echo "This prevents rate limit data from growing indefinitely"

      # ==================== MONITORING & ALERTS ====================
      
      - name: Create Log-Based Metric for Errors
        run: |
          echo "Creating error tracking metric..."
          gcloud logging metrics create function_errors \
            --description="Count of function errors" \
            --log-filter='severity>=ERROR AND resource.type="cloud_function"' \
            --value-extractor='EXTRACT(jsonPayload.error)' 2>/dev/null || echo "Metric already exists"
          
          echo "‚úÖ Logging metrics configured"

      # ==================== DEPLOYMENT SUMMARY ====================

      - name: Deployment Summary
        run: |
          echo "================================"
          echo "üöÄ DEPLOYMENT SUCCESSFUL"
          echo "================================"
          echo ""
          echo "üì¶ Cloud Run:"
          echo "  URL: ${{ steps.deploy_run.outputs.CLOUD_RUN_URL }}"
          echo "  Service Account: ${{ steps.get_sa.outputs.SERVICE_ACCOUNT }}"
          echo ""
          echo "üîå Endpoints:"
          echo "  ‚Ä¢ /health - Health check"
          echo "  ‚Ä¢ /inference - Voice cloning"
          echo "  ‚Ä¢ /extract-audio - Audio extraction"
          echo "  ‚Ä¢ /cluster-speakers - Speaker diarization"
          echo "  ‚Ä¢ /translate-transcript - Translation"
          echo "  ‚Ä¢ /clone-audio - Dubbing clone"
          echo "  ‚Ä¢ /merge-audio - Audio merge"
          echo "  ‚Ä¢ /merge-video - Video merge"
          echo ""
          echo "‚òÅÔ∏è  Firebase Functions:"
          echo "  ‚Ä¢ voice_clone - Main voice cloning"
          echo "  ‚Ä¢ generate_script - AI script generation"
          echo "  ‚Ä¢ dub_transcribe - Start dubbing"
          echo "  ‚Ä¢ dub_translate - Translation"
          echo "  ‚Ä¢ dub_clone - Voice cloning for dubbing"
          echo "  ‚Ä¢ cleanup_pending_credits - Scheduled cleanup"
          echo ""
          echo "üíæ Storage:"
          echo "  ‚Ä¢ fennai-voice-output (24h lifecycle, CORS enabled)"
          echo "  ‚Ä¢ fennai-dubbing-temp (7d lifecycle, CORS enabled)"
          echo ""
          echo "‚öôÔ∏è  Infrastructure:"
          echo "  ‚Ä¢ Queue: voice-generation-queue"
          echo "  ‚Ä¢ Topic: credit-cleanup"
          echo "  ‚Ä¢ Scheduler: credit-cleanup-hourly (runs every hour)"
          echo ""
          echo "üìù Manual Steps Required:"
          echo "  1. Configure Firestore TTL for scriptGenerations"
          echo "  2. Set up monitoring alerts in Cloud Console"
          echo "  3. Review IAM permissions"
          echo "  4. Test all endpoints"
          echo ""
          echo "================================"

      # ==================== POST-DEPLOYMENT TESTS ====================
      
      - name: Run Smoke Tests
        run: |
          echo "üß™ Running smoke tests..."
          
          # Test Cloud Run health
          HEALTH_URL="${{ steps.deploy_run.outputs.CLOUD_RUN_URL }}/health"
          RESPONSE=$(curl -s "$HEALTH_URL")
          echo "Health check response: $RESPONSE"
          
          # Test Firebase Functions (health endpoint if exists)
          # Add your function URL here
          
          echo "‚úÖ Smoke tests completed"

      # ==================== ROLLBACK ON FAILURE ====================
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed, initiating rollback..."
          
          # Rollback Cloud Run to previous revision
          gcloud run services update-traffic fennai-inference \
            --region=us-central1 \
            --to-latest=0 \
            --to-revisions=LATEST=100 \
            || echo "‚ö†Ô∏è  Rollback failed or no previous revision"
          
          echo "üìß Check logs for details"