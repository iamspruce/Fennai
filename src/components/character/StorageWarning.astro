---
// src/components/character/StorageWarning.astro
// Props to tailor the message (optional, defaults to generic if not provided)
interface Props {
  isPro?: boolean;
}

const { isPro = false } = Astro.props;
---

<div
  id="storage-warning"
  class="storage-banner hidden"
  role="alert"
  data-is-pro={isPro}
>
  <div class="banner-icon">
    <svg
      class="icon-warning hidden"
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      ><path d="M15 13a3 3 0 1 0-6 0"></path><path d="M12 17v5"></path><path
        d="M12 2v2"></path><path d="M4.93 19.07l1.41-1.41"></path><path
        d="M17.66 6.34l1.41-1.41"></path><path d="M4.93 4.93l1.41 1.41"
      ></path><path d="M17.66 17.66l1.41 1.41"></path></svg
    >
    <svg
      class="icon-critical hidden"
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      ><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"
      ></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line
        x1="10"
        y1="11"
        x2="10"
        y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg
    >
  </div>

  <div class="banner-content">
    <h3 id="warning-title">Checking storage...</h3>
    <p id="warning-text">...</p>
  </div>

  <div class="banner-actions">
    <button id="manage-storage-btn" type="button" class="btn btn-ghost">
      Manage Storage
    </button>
  </div>
</div>

<script>
  import { getStorageQuota, formatBytes } from "@/lib/db/indexdb";

  // Thresholds
  const WARNING_THRESHOLD = 80; // 80%
  const CRITICAL_THRESHOLD = 95; // 95%

  async function updateStorageWarning() {
    try {
      const quota = await getStorageQuota();
      const container = document.getElementById("storage-warning");
      const titleEl = document.getElementById("warning-title");
      const textEl = document.getElementById("warning-text");
      const iconWarning = container?.querySelector(".icon-warning");
      const iconCritical = container?.querySelector(".icon-critical");

      if (!container || !titleEl || !textEl) return;

      const percent = Math.round(quota.percentUsed);
      const isPro = container.dataset.isPro === "true";

      // Reset classes
      container.classList.remove("hidden", "state-warning", "state-critical");
      iconWarning?.classList.add("hidden");
      iconCritical?.classList.add("hidden");

      if (quota.percentUsed >= CRITICAL_THRESHOLD) {
        // === CRITICAL STATE (Red) ===
        container.classList.add("state-critical");
        iconCritical?.classList.remove("hidden");

        titleEl.textContent = "Emergency diet imminent!";
        textEl.innerHTML = `Your browser is <b>${percent}% full</b>. We'll have to start deleting your oldest media (voices & videos) to make room.`;
      } else if (quota.percentUsed >= WARNING_THRESHOLD) {
        // === WARNING STATE (Orange) ===
        container.classList.add("state-warning");
        iconWarning?.classList.remove("hidden");

        titleEl.textContent = "Your browser is getting heavy...";
        textEl.innerHTML = `You've used <b>${percent}%</b> of your storage (${formatBytes(quota.usage)}). ${
          isPro
            ? "Good thing you're Pro! Sync to cloud to clear space."
            : "If it gets full, voices and videos might vanish!"
        }`;
      } else {
        // === HEALTHY STATE ===
        container.classList.add("hidden");
        return;
      }
    } catch (err) {
      console.warn("Failed to check storage:", err);
    }
  }

  // Update on load and every 30 seconds
  updateStorageWarning();
  setInterval(updateStorageWarning, 30_000);

  // Event Listener for the button
  document
    .getElementById("manage-storage-btn")
    ?.addEventListener("click", () => {
      window.dispatchEvent(new CustomEvent("open-storage-manager"));
    });
</script>

<style>
  /* Base Banner Style (Matches MigrationBanner) */
  .storage-banner {
    display: flex;
    align-items: flex-start;
    gap: var(--space-m);
    padding: var(--space-m);
    background: var(--mauve-2);
    border: 1px solid var(--mauve-6);
    border-radius: var(--radius-l);
    margin: var(--space-m) var(--space-l);
    animation: slideIn 0.3s ease-out;
    transition: all 0.3s ease;
  }

  .storage-banner.hidden {
    display: none !important;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Icon Container */
  .banner-icon {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
    transition: all 0.3s ease;
  }

  /* Content Typography */
  .banner-content {
    flex: 1;
    min-width: 0;
  }

  .banner-content h3 {
    margin: 0 0 var(--space-xs) 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--mauve-12);
  }

  .banner-content p {
    margin: 0;
    font-size: 0.95rem;
    color: var(--mauve-11);
    line-height: 1.5;
  }

  .banner-content b {
    color: var(--mauve-12);
    font-weight: 600;
  }

  /* Button Styles */
  .banner-actions {
    flex-shrink: 0;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-s);
    border: none;
    border-radius: var(--radius-full);
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-ghost {
    background: var(--mauve-5);
    color: var(--mauve-12);
  }
  .btn-ghost:hover {
    background: var(--mauve-6);
    transform: translateY(-1px);
  }

  /* === STATE VARIANTS === */

  /* Warning State (Orange/Amber) */
  .state-warning .banner-icon {
    background: var(--orange-4);
    color: var(--orange-11);
  }
  .state-warning {
    border-color: var(--orange-6);
    background: var(--orange-2);
  }

  /* Critical State (Red/Tomato) */
  .state-critical .banner-icon {
    background: var(--red-4);
    color: var(--red-11);
    animation: pulse 2s infinite;
  }
  .state-critical {
    border-color: var(--red-6);
    background: var(--red-2);
  }
  .state-critical h3 {
    color: var(--red-11);
  }
  .state-critical .btn-ghost {
    background: var(--red-4);
    color: var(--red-11);
  }
  .state-critical .btn-ghost:hover {
    background: var(--red-5);
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
    100% {
      transform: scale(1);
    }
  }

  @media (max-width: 768px) {
    .storage-banner {
      flex-direction: column;
    }
    .banner-actions {
      width: 100%;
      display: flex;
      justify-content: flex-end;
    }
  }
</style>
